<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador de Impresoras — Filtrado por modelo</title>
  <style>
    :root{
      --blue:#0b63c8; --blue-2:#0f5ab0; --accent:#ff6a00;
      --bg:#f4f6fa; --card:#ffffff; --muted:#6b7280;
      --shadow: 0 10px 24px rgba(0,0,0,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg); color:#0f172a;}
    .wrap{max-width:1100px;margin:0 auto;padding:42px 20px 80px}
    h1{margin:0 0 20px;text-align:center;font-size:clamp(28px,4vw,46px);letter-spacing:.5px;color:var(--blue);font-weight:800}
    .searchbar{display:flex;gap:12px;justify-content:center;margin:10px auto 18px;max-width:860px}
    .searchbar input{flex:1;min-width:300px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px 16px;font-size:16px;outline:none;box-shadow:var(--shadow)}
    .btn{border:0;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer;transition:.18s transform ease;box-shadow:var(--shadow)}
    .btn:active{transform:scale(.98)}
    .btn-clear{background:var(--accent);color:#fff;}
    .btn-google{display:block;margin:22px auto 0;background:#d93025;color:#fff}
    .grid{display:grid;gap:22px;grid-template-columns:1fr;margin-top:8px}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr;} }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid #eef2f7}
    .card header{padding:16px 18px;background:linear-gradient(0deg,#fafcff, #ffffff);border-bottom:1px solid #eef2f7;font-weight:800;color:var(--blue-2);display:flex;justify-content:space-between;align-items:center}
    .count{color:#64748b;font-weight:700;font-size:14px}
    .card .body{padding:18px;min-height:220px;color:#111827;line-height:1.45}
    footer{margin-top:32px;text-align:center;color:#94a3b8;font-size:12px}
    ul{margin:0;padding-left:18px}
    li{margin:.3rem 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BUSCADOR DE IMPRESORAS</h1>
    <div class="searchbar" role="search">
      <input id="q" type="text" placeholder="TS3350, TS 3350, 3350, Canon 3350, TR4751…" autocomplete="off">
      <button id="clear" class="btn btn-clear" aria-label="Limpiar búsqueda">Limpiar</button>
    </div>
    <div class="grid">
      <section class="card" aria-labelledby="h-consumibles">
        <header>
          <span id="h-consumibles">CONSUMIBLES</span>
          <span id="count-cons" class="count">—</span>
        </header>
        <div id="consumibles" class="body">—</div>
      </section>
      <section class="card" aria-labelledby="h-capacidad">
        <header>
          <span id="h-capacidad">CAPACIDAD</span>
          <span id="count-cap" class="count">—</span>
        </header>
        <div id="capacidad" class="body">—</div>
      </section>
    </div>
    <button id="google" class="btn btn-google">Buscar en Google</button>
    <footer>© 2025 — Buscador de consumibles y capacidades</footer>
  </div>

<script>
(async () => {
  const $ = sel => document.querySelector(sel);
  const input = $('#q');
  const outCons = $('#consumibles');
  const outCap = $('#capacidad');
  const cntCons = $('#count-cons');
  const cntCap = $('#count-cap');
  const btnClear = $('#clear');
  const btnGoogle = $('#google');

  const DATASET_CANDIDATES = [
    './dataset_impresoras_v2.json',
    'https://raw.githubusercontent.com/guiradimar/MODELO-IMPRESORA.MC/main/dataset_impresoras_v2.json'
  ];

  // Normaliza, separa letras y números, tokeniza
  const normalize = s => (s||'')
    .toLowerCase()
    .replace(/([a-z])([0-9])/g, '$1 $2')
    .replace(/([0-9])([a-z])/g, '$1 $2')
    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,' ')
    .replace(/\\s+/g,' ')
    .trim();

  const BRAND_STOPWORDS = new Set(['canon','hp','hewlett','epson','brother','lexmark','xerox','ricoh','kyocera','oki','samsung']);
  const SERIES_ALIASES = [
    {key:'ts',  re:/\\bpixma\\s*ts\\b/},
    {key:'mg',  re:/\\bpixma\\s*mg\\b/},
    {key:'mx',  re:/\\bpixma\\s*mx\\b/},
    {key:'tr',  re:/\\bpixma\\s*tr\\b|\\btr\\b/},
    {key:'dj',  re:/\\bdeskjet\\b|\\bdj\\b/},
    {key:'lj',  re:/\\blaserjet\\b|\\blj\\b/},
    {key:'wc',  re:/\\bworkcentre\\b|\\bworkcenter\\b|\\bwc\\b/}
  ];

  const numberTokens = s => (normalize(s).match(/\\b\\d{2,6}\\b/g) || []);

  function modelTokensFromCompat(compatRaw){
    const n = ' ' + normalize(compatRaw) + ' ';
    const toks = new Set();
    // series detectadas explícitas
    for (const {key,re} of SERIES_ALIASES){
      if (re.test(n)) toks.add(key);
    }
    // números (modelos)
    for (const num of numberTokens(n)) toks.add(num);
    // si aparece 'pixma', añadimos 'canon' implícito (no se usa para filtrar, pero queda como metadato)
    if (/\\bpixma\\b/.test(n)) toks.add('canon');
    return toks;
  }

  function tokenizeQuery(q){
    const t = normalize(q).split(' ').filter(Boolean);
    // filtra marcas; si queda vacío, usa original
    const filtered = t.filter(x => !BRAND_STOPWORDS.has(x));
    return filtered.length ? filtered : t;
  }

  function buildIndex(data){
    return data.map(row => {
      const compat = [String(row.compatibilidades||row.compatibilidad||'')].join(' ');
      const tokens = modelTokensFromCompat(compat);
      const cons = String(row.consumibles||row.cartucho||row.consumible||'').split(/\\s*[;,\\/|]\\s*/).filter(Boolean);
      const cap  = String(row.capacidad||row.cap||'').split(/\\s*[;,\\/|]\\s*/).filter(Boolean);
      return { tokens, cons, cap };
    });
  }

  async function loadData(){
    for (const url of DATASET_CANDIDATES){
      try{
        const r = await fetch(url, {cache:'reload'});
        if (r.ok){
          const json = await r.json();
          if (Array.isArray(json)) return json;
        }
      }catch(_){}
    }
    return [];
  }

  function searchIndex(index, qRaw){
    const qTokens = tokenizeQuery(qRaw);
    if (!qTokens.length){ render([],[]); return; }
    // Separar tokens letra/serie (ts, mg, tr, wc...) y números
    const seriesQ = new Set(qTokens.filter(t => isNaN(Number(t)) === true));
    const numsQ   = new Set(qTokens.filter(t => /^\\d{2,6}$/.test(t)));
    const setC = new Set(), setK = new Set();
    for (const it of index){
      // Regla: si la query trae serie (ts/mg/tr...), esa serie DEBE estar en tokens del índice
      // y todos los números de la query DEBEN estar también.
      let ok = true;
      for (const s of seriesQ){ if (!it.tokens.has(s)) { ok=false; break; } }
      if (!ok) continue;
      for (const n of numsQ){ if (!it.tokens.has(n)) { ok=false; break; } }
      if (!ok) continue;
      // Si la query solo trae número (3350), pedimos que el número esté en tokens (compatibilidades)
      if (!seriesQ.size && numsQ.size && !Array.from(numsQ).every(n=>it.tokens.has(n))) continue;
      // Si la query no trae ni serie ni número (raro), no devolvemos nada.
      if (!seriesQ.size && !numsQ.size) continue;

      it.cons.forEach(x => x && setC.add(x));
      it.cap.forEach(x => x && setK.add(x));
    }
    render(Array.from(setC), Array.from(setK));
  }

  function render(consumibles, capacidades){
    const toList = arr => arr.length ? '<ul>'+arr.map(v=>'<li>'+v.replace(/[&<>]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[s]))+'</li>').join('')+'</ul>' : '—';
    outCons.innerHTML = toList(consumibles);
    outCap.innerHTML = toList(capacidades);
    cntCons.textContent = String(consumibles.length || 0);
    cntCap.textContent = String(capacidades.length || 0);
  }

  const DATA = await loadData();
  const INDEX = buildIndex(DATA);

  const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms) } };
  const doSearch = ()=> searchIndex(INDEX, input.value);
  input.addEventListener('input', debounce(doSearch, 150));
  input.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); doSearch(); } });
  btnClear.addEventListener('click', ()=>{ input.value=''; render([],[]); input.focus(); });
  btnGoogle.addEventListener('click', ()=>{ const q=input.value.trim(); if(q) window.open('https://www.google.com/search?q='+encodeURIComponent(q),'_blank'); });

  // ?q= inicial
  const qParam = new URL(location).searchParams.get('q');
  if (qParam){ input.value = qParam; }
  doSearch();
})();
</script>
</body>
</html>
